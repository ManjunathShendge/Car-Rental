<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Cars</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        input, button { padding: 10px; margin: 5px 0; width: 300px; }
        button { cursor: pointer; }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        img { width: 100px; }
        .edit-btn, .delete-btn { cursor: pointer; margin-right: 5px; }
    </style>
</head>
<body>
    <h1>Admin Dashboard - Cars</h1>

    <h3>Add / Edit Car</h3>
    <input type="hidden" id="carId">
    <input type="text" id="carName" placeholder="Car Name"><br>
    <input type="text" id="carType" placeholder="Car Type"><br>
    <input type="number" id="carPrice" placeholder="Price per Day"><br>
    <input type="number" id="carSeats" placeholder="Seats"><br>
    <input type="text" id="carTransmission" placeholder="Transmission"><br>
    <input type="text" id="carFuel" placeholder="Fuel"><br>
    <input type="number" id="carYear" placeholder="Year"><br>
    <input type="text" id="carCogs" placeholder="Cogs"><br>
    <input type="text" id="carMileage" placeholder="Mileage"><br>
    <label>Available: <input type="checkbox" id="carAvailable" checked></label><br>
    <input type="file" id="carImageFile"><br>
    <button id="saveCarBtn">Save Car</button>

    <h3>Available Cars</h3>
    <table id="carTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Price/Day</th>
                <th>Image</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAtbrmz6LH5LK5weDJHrl78W71WU6VAQOs",
            authDomain: "carrentalapp-1dc5d.firebaseapp.com",
            projectId: "carrentalapp-1dc5d",
            storageBucket: "carrentalapp-1dc5d.appspot.com",
            messagingSenderId: "361942863396",
            appId: "1:361942863396:web:f0439dd1cd9a5c58e592b1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const saveBtn = document.getElementById("saveCarBtn");

        saveBtn.addEventListener("click", async () => {
            const id = document.getElementById("carId").value;
            const name = document.getElementById("carName").value.trim();
            const type = document.getElementById("carType").value.trim();
            const price = parseFloat(document.getElementById("carPrice").value);
            const seats = parseInt(document.getElementById("carSeats").value);
            const transmission = document.getElementById("carTransmission").value.trim();
            const fuel = document.getElementById("carFuel").value.trim();
            const year = parseInt(document.getElementById("carYear").value);
            const cogs = document.getElementById("carCogs").value.trim();
            const mileage = document.getElementById("carMileage").value.trim();
            const available = document.getElementById("carAvailable").checked;
            const file = document.getElementById("carImageFile").files[0];

            if (!name || !type || !price || !file) {
                alert("Please fill all required fields and select an image!");
                return;
            }

            try {
                // Upload image to Firebase Storage
                const storageRef = ref(storage, `cars/${file.name}`);
                await uploadBytes(storageRef, file);
                const imageUrl = await getDownloadURL(storageRef);

                const carData = {
                    name,
                    type,
                    pricePerDay: price,
                    image: imageUrl,
                    seats,
                    transmission,
                    fuel,
                    year,
                    cogs,
                    mileage,
                    available,
                    createdAt: new Date()
                };

                if (id) {
                    await updateDoc(doc(db, "cars", id), carData);
                    alert("Car updated successfully!");
                } else {
                    await addDoc(collection(db, "cars"), carData);
                    alert("Car added successfully!");
                }

                // Reset form
                document.getElementById("carId").value = "";
                document.getElementById("carName").value = "";
                document.getElementById("carType").value = "";
                document.getElementById("carPrice").value = "";
                document.getElementById("carSeats").value = "";
                document.getElementById("carTransmission").value = "";
                document.getElementById("carFuel").value = "";
                document.getElementById("carYear").value = "";
                document.getElementById("carCogs").value = "";
                document.getElementById("carMileage").value = "";
                document.getElementById("carAvailable").checked = true;
                document.getElementById("carImageFile").value = "";

                loadCars();
            } catch (err) {
                console.error(err);
                alert("Error saving car. Check console.");
            }
        });

        async function loadCars() {
            const tbody = document.querySelector("#carTable tbody");
            tbody.innerHTML = "";
            const querySnapshot = await getDocs(collection(db, "cars"));

            querySnapshot.forEach(docSnap => {
                const car = docSnap.data();
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${car.name}</td>
                    <td>${car.type}</td>
                    <td>${car.pricePerDay}</td>
                    <td><img src="${car.image}" alt="${car.name}"></td>
                    <td>
                        <span class="edit-btn" data-id="${docSnap.id}" style="color:blue;"><i class="fas fa-edit"></i></span>
                        <span class="delete-btn" data-id="${docSnap.id}" style="color:red;"><i class="fas fa-trash"></i></span>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll(".edit-btn").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const id = btn.dataset.id;
                    const carDoc = await getDocs(collection(db, "cars"));
                    const carData = carDoc.docs.find(d => d.id === id).data();

                    document.getElementById("carId").value = id;
                    document.getElementById("carName").value = carData.name;
                    document.getElementById("carType").value = carData.type;
                    document.getElementById("carPrice").value = carData.pricePerDay;
                    document.getElementById("carSeats").value = carData.seats;
                    document.getElementById("carTransmission").value = carData.transmission;
                    document.getElementById("carFuel").value = carData.fuel;
                    document.getElementById("carYear").value = carData.year;
                    document.getElementById("carCogs").value = carData.cogs;
                    document.getElementById("carMileage").value = carData.mileage;
                    document.getElementById("carAvailable").checked = carData.available;
                });
            });

            document.querySelectorAll(".delete-btn").forEach(btn => {
                btn.addEventListener("click", async () => {
                    if (!confirm("Are you sure you want to delete this car?")) return;
                    await deleteDoc(doc(db, "cars", btn.dataset.id));
                    loadCars();
                });
            });
        }

        loadCars();
    </script>
</body>
</html>
